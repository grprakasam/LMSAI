<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R Tutor Pro - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <i class="fab fa-r-project"></i> R Tutor Pro
        </div>
        <div class="nav-right">
            <div class="user-menu">
                <span>Welcome back!</span>
                <a href="/admin" class="btn btn-sm">Admin</a>
                <a href="/logout" class="btn btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div class="header-section">
                <h1><i class="fas fa-graduation-cap"></i> Create Your R Learning Content</h1>
                <p class="subtitle">Choose your preferred format and generate personalized R tutorials instantly</p>
            </div>

            <!-- Single Form with Radio Button Selection -->
            <form id="contentForm" class="content-form">
                <!-- Output Type Selection -->
                <div class="output-type-section">
                    <h3><i class="fas fa-list-ul"></i> Choose Output Format</h3>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="output_type" value="text" checked>
                            <span class="radio-custom"></span>
                            <div class="option-content">
                                <i class="fas fa-file-text"></i>
                                <h4>Text Output</h4>
                                <p>Comprehensive written tutorial with examples</p>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="output_type" value="audio">
                            <span class="radio-custom"></span>
                            <div class="option-content">
                                <i class="fas fa-volume-up"></i>
                                <h4>Audio Output</h4>
                                <p>Streaming narrated content with Kyutai TTS</p>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="output_type" value="animated">
                            <span class="radio-custom"></span>
                            <div class="option-content">
                                <i class="fas fa-film"></i>
                                <h4>Animated Output</h4>
                                <p>Interactive visual animations and demos</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Content Input Section -->
                <div class="input-section">
                    <div class="form-group">
                        <label for="topic">
                            <i class="fas fa-book"></i> R Programming Topic
                        </label>
                        <input type="text" id="topic" name="topic" class="form-control" 
                               placeholder="e.g., ggplot2 visualization, machine learning with caret, data manipulation..." required>
                        <div class="topic-suggestions">
                            <button type="button" class="suggestion-btn" data-topic="Data Structures">Data Structures</button>
                            <button type="button" class="suggestion-btn" data-topic="ggplot2 Visualization">ggplot2</button>
                            <button type="button" class="suggestion-btn" data-topic="Machine Learning">Machine Learning</button>
                            <button type="button" class="suggestion-btn" data-topic="Data Analysis">Data Analysis</button>
                            <button type="button" class="suggestion-btn" data-topic="Statistical Modeling">Statistics</button>
                            <button type="button" class="suggestion-btn" data-topic="Shiny Applications">Shiny Apps</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="expertise">
                                <i class="fas fa-user-graduate"></i> Expertise Level
                            </label>
                            <select id="expertise" name="expertise" class="form-control" required>
                                <option value="">Select your level</option>
                                <option value="beginner" selected>🌱 Beginner</option>
                                <option value="intermediate">🌿 Intermediate</option>
                                <option value="expert">🌳 Expert</option>
                            </select>
                        </div>

                        <div class="form-group" id="durationGroup">
                            <label for="duration">
                                <i class="fas fa-clock"></i> Duration: <span id="durationDisplay">5</span> min
                            </label>
                            <input type="range" id="duration" name="duration" min="2" max="15" value="5" class="form-control slider">
                        </div>

                        <div class="form-group" id="contentLengthGroup" style="display: none;">
                            <label>
                                <i class="fas fa-text-width"></i> Content Length
                            </label>
                            <div class="radio-group-inline">
                                <label class="radio-option-inline">
                                    <input type="radio" name="content_length" value="short" checked>
                                    <span class="radio-custom-inline"></span>
                                    <span class="option-text">Short Content</span>
                                </label>
                                <label class="radio-option-inline">
                                    <input type="radio" name="content_length" value="medium">
                                    <span class="radio-custom-inline"></span>
                                    <span class="option-text">Medium Content</span>
                                </label>
                                <label class="radio-option-inline">
                                    <input type="radio" name="content_length" value="lengthy">
                                    <span class="radio-custom-inline"></span>
                                    <span class="option-text">Lengthy Content</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="generateBtn" class="btn btn-primary btn-generate">
                        <i class="fas fa-magic"></i> Generate Content
                    </button>
                </div>

            </form>

            <!-- Loading State -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p id="loadingText">🧠 Creating your personalized content...</p>
            </div>

            <!-- Results Section -->
            <div id="resultSection" class="result-section" style="display: none;">
                <div class="result-header">
                    <h2 id="resultTitle"><i class="fas fa-check-circle"></i> Content Ready!</h2>
                    <div class="result-meta">
                        <span id="outputTypeTag" class="result-tag"></span>
                        <span id="topicTag" class="result-tag"></span>
                    </div>
                </div>
                
                <div id="contentDisplay" class="content-display">
                    <!-- Dynamic content will be inserted here -->
                </div>
                
                <div id="audioPlayer" class="audio-player" style="display: none;">
                    <!-- Kyutai TTS audio player will be inserted here -->
                </div>
                
                <div class="result-actions">
                    <button id="copyBtn" class="btn btn-secondary">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button id="shareBtn" class="btn btn-primary">
                        <i class="fas fa-share"></i> Share
                    </button>
                    <button id="downloadBtn" class="btn btn-success">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>

            <!-- Stats and Recent Content -->
            <div class="sidebar-info">
                <div class="stats-card">
                    <h3><i class="fas fa-chart-bar"></i> Usage Stats</h3>
                    <div class="stat-item">
                        <span class="stat-number">{{ stats.monthly_usage }}</span>
                        <span class="stat-label">This Month</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ stats.total_tutorials }}</span>
                        <span class="stat-label">Total Created</span>
                    </div>
                </div>

                <div class="recent-content">
                    <h3><i class="fas fa-history"></i> Recent Content</h3>
                    <div id="recentList">
                        <!-- Recent content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= GLOBAL STATE =============
        let currentContent = null;
        let currentOutputType = 'text';

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadRecentContent();
            // Initialize UI for default text output
            updateUIForOutputType('text');
        });

        function initializeEventListeners() {
            // Topic suggestions
            document.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('topic').value = this.dataset.topic;
                });
            });

            // Duration slider
            document.getElementById('duration').addEventListener('input', function() {
                document.getElementById('durationDisplay').textContent = this.value;
            });

            // Radio button change
            document.querySelectorAll('input[name="output_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentOutputType = this.value;
                    updateUIForOutputType(this.value);
                });
            });

            // Form submission
            document.getElementById('contentForm').addEventListener('submit', handleFormSubmission);

            // Action buttons
            document.getElementById('copyBtn').addEventListener('click', copyContent);
            document.getElementById('shareBtn').addEventListener('click', shareContent);
            document.getElementById('downloadBtn').addEventListener('click', downloadContent);
        }

        function updateUIForOutputType(outputType) {
            // Update loading message based on output type
            const loadingMessages = {
                'text': '📝 Generating comprehensive text tutorial...',
                'audio': '🎵 Creating streaming audio content with Kyutai TTS...',
                'animated': '🎬 Building interactive animated tutorial...'
            };
            
            document.getElementById('loadingText').textContent = loadingMessages[outputType];
            
            // Show/hide appropriate controls based on output type
            const durationGroup = document.getElementById('durationGroup');
            const contentLengthGroup = document.getElementById('contentLengthGroup');
            
            if (outputType === 'text') {
                durationGroup.style.display = 'none';
                contentLengthGroup.style.display = 'block';
            } else {
                durationGroup.style.display = 'block';
                contentLengthGroup.style.display = 'none';
            }
        }

        // ============= FORM HANDLING =============
        async function handleFormSubmission(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const contentData = {
                topic: formData.get('topic'),
                expertise: formData.get('expertise'),
                duration: parseInt(formData.get('duration')),
                output_type: formData.get('output_type'),
                content_length: formData.get('content_length')
            };

            if (!contentData.topic || !contentData.expertise) {
                alert('Please fill in all required fields.');
                return;
            }

            await generateContent(contentData);
        }

        async function generateContent(data) {
            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const resultSection = document.getElementById('resultSection');

            // Show loading state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            loading.style.display = 'block';
            resultSection.style.display = 'none';

            try {
                const response = await fetch('/generate-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    currentContent = result;
                    displayResults(result);
                    loadRecentContent();
                } else {
                    alert(result.error || 'Failed to generate content');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            } finally {
                // Reset UI
                loading.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Content';
            }
        }

        // ============= RESULTS DISPLAY =============
        function displayResults(result) {
            const resultSection = document.getElementById('resultSection');
            const contentDisplay = document.getElementById('contentDisplay');
            const audioPlayer = document.getElementById('audioPlayer');
            
            // Update meta tags
            document.getElementById('outputTypeTag').textContent = getOutputTypeLabel(result.output_type);
            document.getElementById('topicTag').textContent = result.topic;

            // Clear previous content
            contentDisplay.innerHTML = '';
            audioPlayer.style.display = 'none';

            // Display content based on output type
            switch (result.output_type) {
                case 'text':
                    displayTextContent(result);
                    break;
                case 'audio':
                    displayAudioContent(result);
                    break;
                case 'animated':
                    displayAnimatedContent(result);
                    break;
            }

            // Show results
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayTextContent(result) {
            const contentDisplay = document.getElementById('contentDisplay');
            
            // Process content to render markdown properly
            const processedContent = renderMarkdownContent(result.content);
            
            contentDisplay.innerHTML = `
                <div class="text-content markdown-content">
                    <div class="content-header">
                        <h3>${result.topic}</h3>
                        <div class="content-meta">
                            <span class="meta-tag">${result.expertise} level</span>
                            <span class="meta-tag">${result.content_length || 'medium'} length</span>
                        </div>
                    </div>
                    <div class="content-body">
                        ${processedContent}
                    </div>
                </div>
            `;
        }
        
        function renderMarkdownContent(content) {
            // Simple markdown-to-HTML converter for better readability
            let html = content
                // Headers
                .replace(/^### (.*$)/gim, '<h3 class="content-h3">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="content-h2">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="content-h1">$1</h1>')
                // Code blocks
                .replace(/```r\n([\s\S]*?)```/g, '<div class="code-block r-code"><pre><code>$1</code></pre></div>')
                .replace(/```([\s\S]*?)```/g, '<div class="code-block"><pre><code>$1</code></pre></div>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong class="content-bold">$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em class="content-italic">$1</em>')
                // Lists
                .replace(/^\* (.*$)/gim, '<li class="list-item">$1</li>')
                .replace(/^- (.*$)/gim, '<li class="list-item">$1</li>')
                // Line breaks
                .replace(/\n\n/g, '</p><p class="content-paragraph">')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraph tags and handle lists
            html = '<p class="content-paragraph">' + html + '</p>';
            html = html.replace(/(<li class="list-item">.*<\/li>)/gs, function(match) {
                return '<ul class="content-list">' + match + '</ul>';
            });
            
            return html;
        }

        function displayAudioContent(result) {
            const contentDisplay = document.getElementById('contentDisplay');
            const audioPlayer = document.getElementById('audioPlayer');

            // Show text content first
            contentDisplay.innerHTML = `
                <div class="audio-content">
                    <div class="content-header">
                        <h3>🎵 ${result.topic}</h3>
                        <p class="audio-desc">Streaming audio content with Kyutai TTS</p>
                    </div>
                    <div class="content-body">
                        ${result.content}
                    </div>
                </div>
            `;

            // Set up streaming audio
            if (result.audio_stream_url) {
                audioPlayer.innerHTML = `
                    <div class="stream-player">
                        <h4><i class="fas fa-broadcast-tower"></i> Live Audio Stream</h4>
                        <audio controls autoplay id="streamAudio" style="width: 100%;">
                            <source src="${result.audio_stream_url}" type="audio/mpeg">
                            Your browser does not support audio streaming.
                        </audio>
                        <p class="stream-info">🔴 Streaming live with Kyutai TTS</p>
                    </div>
                `;
                audioPlayer.style.display = 'block';
            }
        }

        function displayAnimatedContent(result) {
            const contentDisplay = document.getElementById('contentDisplay');
            contentDisplay.innerHTML = `
                <div class="animated-content">
                    <div class="content-header">
                        <h3>🎬 ${result.topic}</h3>
                        <p class="animation-desc">Interactive animated tutorial</p>
                    </div>
                    <div class="animation-container">
                        ${result.animation_html || '<p>Animation content loading...</p>'}
                    </div>
                    <div class="animation-controls" style="margin-top: 1rem;">
                        <button class="control-btn" onclick="restartAnimation()">
                            <i class="fas fa-redo"></i> Restart
                        </button>
                        <button class="control-btn" onclick="togglePlayPause()">
                            <i class="fas fa-play"></i> Play
                        </button>
                    </div>
                </div>
            `;
        }

        // ============= ACTION HANDLERS =============
        function copyContent() {
            if (!currentContent) return;
            
            let textToCopy = '';
            switch (currentContent.output_type) {
                case 'text':
                case 'audio':
                    textToCopy = currentContent.content.replace(/<[^>]*>/g, '');
                    break;
                case 'animated':
                    textToCopy = `Animated Tutorial: ${currentContent.topic}`;
                    break;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('Content copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy content.');
            });
        }

        function shareContent() {
            if (!currentContent) return;
            
            const shareData = {
                title: `R Tutorial: ${currentContent.topic}`,
                text: `Check out this R tutorial on ${currentContent.topic}`,
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                navigator.clipboard.writeText(shareData.url);
                alert('Tutorial link copied to clipboard!');
            }
        }

        function downloadContent() {
            if (!currentContent) return;
            
            const filename = `r-tutorial-${currentContent.topic.replace(/\s+/g, '-').toLowerCase()}.txt`;
            let content = '';
            
            switch (currentContent.output_type) {
                case 'text':
                case 'audio':
                    content = `R Tutorial: ${currentContent.topic}\n\n${currentContent.content.replace(/<[^>]*>/g, '')}`;
                    break;
                case 'animated':
                    content = `R Animated Tutorial: ${currentContent.topic}\n\nThis is an interactive animated tutorial.`;
                    break;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============= UTILITY FUNCTIONS =============
        function getOutputTypeLabel(type) {
            const labels = {
                'text': '📝 Text Tutorial',
                'audio': '🎵 Audio Content',
                'animated': '🎬 Animated Tutorial'
            };
            return labels[type] || type;
        }

        async function loadRecentContent() {
            try {
                const response = await fetch('/api/recent-content');
                const data = await response.json();
                
                const recentList = document.getElementById('recentList');
                if (data.length === 0) {
                    recentList.innerHTML = '<p>No content created yet.</p>';
                    return;
                }

                recentList.innerHTML = data.map(item => `
                    <div class="recent-item">
                        <div class="recent-title">${item.topic}</div>
                        <div class="recent-meta">
                            ${getOutputTypeLabel(item.output_type)} • ${item.expertise}
                            <br><small>${new Date(item.created_at).toLocaleDateString()}</small>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load recent content:', error);
            }
        }

        // ============= ANIMATION CONTROLS =============
        function restartAnimation() {
            const animationContainer = document.querySelector('.animation-container');
            if (animationContainer) {
                // Reset animations
                animationContainer.style.animation = 'none';
                animationContainer.offsetHeight; // Trigger reflow
                animationContainer.style.animation = null;
            }
        }

        function togglePlayPause() {
            // Animation play/pause logic would go here
            console.log('Toggle play/pause animation');
        }

    </script>
</body>
</html>
