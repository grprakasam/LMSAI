<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R Learning- AI powered</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <i class="fab fa-r-project"></i> R Learning- AI powered
        </div>
        <div class="nav-right">
            <div class="user-menu">
                <span>Welcome back!</span>
                <a href="/admin" class="btn btn-sm">Admin</a>
                <a href="/logout" class="btn btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div class="header-section">
                <h1><i class="fas fa-graduation-cap"></i> Create Your R Learning Content</h1>
                <p class="subtitle">Choose your preferred format and generate personalized R tutorials with AI power</p>
            </div>

            <!-- Single Form with Radio Button Selection -->
            <form id="contentForm" class="content-form">
                <!-- Output Type Selection -->
                <div class="output-type-section">
                    <h3><i class="fas fa-list-ul"></i> Choose Output Format</h3>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="output_type" value="text" checked>
                            <span class="radio-custom"></span>
                            <div class="option-content">
                                <i class="fas fa-file-text"></i>
                                <h4>Text Output</h4>
                                <p>Comprehensive written tutorial with examples</p>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="output_type" value="audio">
                            <span class="radio-custom"></span>
                            <div class="option-content">
                                <i class="fas fa-volume-up"></i>
                                <h4>Audio Output</h4>
                                <p>Streaming narrated content with Kyutai TTS</p>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="output_type" value="animated">
                            <span class="radio-custom"></span>
                            <div class="option-content">
                                <i class="fas fa-film"></i>
                                <h4>Animated Output</h4>
                                <p>Interactive animated presentation with audio and controls</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Content Input Section -->
                <div class="input-section">
                    <div class="form-group">
                        <label for="topic">
                            <i class="fas fa-book"></i> R Programming Topic
                        </label>
                        <input type="text" id="topic" name="topic" class="form-control" 
                               placeholder="e.g., ggplot2 visualization, machine learning with caret, data manipulation..." required>
                        <div class="topic-suggestions">
                            <button type="button" class="suggestion-btn" data-topic="Data Structures">Data Structures</button>
                            <button type="button" class="suggestion-btn" data-topic="ggplot2 Visualization">ggplot2</button>
                            <button type="button" class="suggestion-btn" data-topic="Machine Learning">Machine Learning</button>
                            <button type="button" class="suggestion-btn" data-topic="Data Analysis">Data Analysis</button>
                            <button type="button" class="suggestion-btn" data-topic="Statistical Modeling">Statistics</button>
                            <button type="button" class="suggestion-btn" data-topic="Shiny Applications">Shiny Apps</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="expertise">
                                <i class="fas fa-user-graduate"></i> Expertise Level
                            </label>
                            <select id="expertise" name="expertise" class="form-control" required>
                                <option value="">Select your level</option>
                                <option value="beginner" selected>üå± Beginner</option>
                                <option value="intermediate">üåø Intermediate</option>
                                <option value="expert">üå≥ Expert</option>
                            </select>
                        </div>

                        <div class="form-group" id="durationGroup">
                            <label for="duration">
                                <i class="fas fa-clock"></i> Duration: <span id="durationDisplay">5</span> min
                            </label>
                            <input type="range" id="duration" name="duration" min="2" max="15" value="5" class="form-control slider">
                        </div>

                        <div class="form-group" id="contentLengthGroup" style="display: none;">
                            <label>
                                <i class="fas fa-text-width"></i> Content Length
                            </label>
                            <div class="radio-group-inline">
                                <label class="radio-option-inline">
                                    <input type="radio" name="content_length" value="short" checked>
                                    <span class="radio-custom-inline"></span>
                                    <span class="option-text">Short Content</span>
                                </label>
                                <label class="radio-option-inline">
                                    <input type="radio" name="content_length" value="medium">
                                    <span class="radio-custom-inline"></span>
                                    <span class="option-text">Medium Content</span>
                                </label>
                                <label class="radio-option-inline">
                                    <input type="radio" name="content_length" value="lengthy">
                                    <span class="radio-custom-inline"></span>
                                    <span class="option-text">Lengthy Content</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="generateBtn" class="btn btn-primary btn-generate">
                        <i class="fas fa-magic"></i> Generate Content
                    </button>
                </div>

            </form>

            <!-- Loading State -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p id="loadingText">üß† Creating your personalized content...</p>
            </div>

            <!-- Results Section -->
            <div id="resultSection" class="result-section" style="display: none;">
                <div class="result-header">
                    <h2 id="resultTitle"><i class="fas fa-check-circle"></i> Content Ready!</h2>
                    <div class="result-meta">
                        <span id="outputTypeTag" class="result-tag"></span>
                        <span id="topicTag" class="result-tag"></span>
                    </div>
                </div>
                
                <div id="contentDisplay" class="content-display">
                    <!-- Dynamic content will be inserted here -->
                </div>
                
                <div id="audioPlayer" class="audio-player" style="display: none;">
                    <!-- Kyutai TTS audio player will be inserted here -->
                </div>
                
                <div class="result-actions">
                    <button id="copyBtn" class="btn btn-secondary">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button id="shareBtn" class="btn btn-primary">
                        <i class="fas fa-share"></i> Share
                    </button>
                    <button id="downloadBtn" class="btn btn-success">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>

            <!-- AI Learning Assistant Info -->
            <div class="ai-assistant-info">
                <div class="assistant-card">
                    <h3><i class="fas fa-robot"></i> AI Learning Assistant</h3>
                    <p class="assistant-desc">Powered by advanced AI models to create personalized R learning experiences tailored to your expertise level.</p>
                    <div class="features-list">
                        <div class="feature-item">
                            <i class="fas fa-brain"></i>
                            <span>Smart Content Generation</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-video"></i>
                            <span>Interactive Animations</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-volume-up"></i>
                            <span>Audio Narration</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= GLOBAL STATE =============
        let currentContent = null;
        let currentOutputType = 'text';

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            // Initialize UI for default text output
            updateUIForOutputType('text');
        });

        function initializeEventListeners() {
            // Topic suggestions
            document.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('topic').value = this.dataset.topic;
                });
            });

            // Duration slider
            document.getElementById('duration').addEventListener('input', function() {
                document.getElementById('durationDisplay').textContent = this.value;
            });

            // Radio button change
            document.querySelectorAll('input[name="output_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentOutputType = this.value;
                    updateUIForOutputType(this.value);
                });
            });

            // Form submission
            document.getElementById('contentForm').addEventListener('submit', handleFormSubmission);

            // Action buttons
            document.getElementById('copyBtn').addEventListener('click', copyContent);
            document.getElementById('shareBtn').addEventListener('click', shareContent);
            document.getElementById('downloadBtn').addEventListener('click', downloadContent);
        }

        function updateUIForOutputType(outputType) {
            // Update loading message based on output type
            const loadingMessages = {
                'text': 'üìù Generating comprehensive text tutorial...',
                'audio': 'üéµ Creating streaming audio content with Kyutai TTS...',
                'animated': 'üé¨ Building interactive animated tutorial...'
            };
            
            document.getElementById('loadingText').textContent = loadingMessages[outputType];
            
            // Show/hide appropriate controls based on output type
            const durationGroup = document.getElementById('durationGroup');
            const contentLengthGroup = document.getElementById('contentLengthGroup');
            
            if (outputType === 'text') {
                durationGroup.style.display = 'none';
                contentLengthGroup.style.display = 'block';
            } else {
                durationGroup.style.display = 'block';
                contentLengthGroup.style.display = 'none';
            }
        }

        // ============= FORM HANDLING =============
        async function handleFormSubmission(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const contentData = {
                topic: formData.get('topic'),
                expertise: formData.get('expertise'),
                duration: parseInt(formData.get('duration')),
                output_type: formData.get('output_type'),
                content_length: formData.get('content_length')
            };

            if (!contentData.topic || !contentData.expertise) {
                alert('Please fill in all required fields.');
                return;
            }

            await generateContent(contentData);
        }

        async function generateContent(data) {
            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const resultSection = document.getElementById('resultSection');

            // Show loading state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            loading.style.display = 'block';
            resultSection.style.display = 'none';

            try {
                const response = await fetch('/generate-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    currentContent = result;
                    displayResults(result);
                } else {
                    alert(result.error || 'Failed to generate content');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            } finally {
                // Reset UI
                loading.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Content';
            }
        }

        // ============= RESULTS DISPLAY =============
        function displayResults(result) {
            const resultSection = document.getElementById('resultSection');
            const contentDisplay = document.getElementById('contentDisplay');
            const audioPlayer = document.getElementById('audioPlayer');
            
            // Update meta tags
            document.getElementById('outputTypeTag').textContent = getOutputTypeLabel(result.output_type);
            document.getElementById('topicTag').textContent = result.topic;

            // Clear previous content
            contentDisplay.innerHTML = '';
            audioPlayer.style.display = 'none';

            // Display content based on output type
            switch (result.output_type) {
                case 'text':
                    displayTextContent(result);
                    break;
                case 'audio':
                    displayAudioContent(result);
                    break;
                case 'animated':
                    displayAnimatedContent(result);
                    break;
            }

            // Show results
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayTextContent(result) {
            const contentDisplay = document.getElementById('contentDisplay');
            
            // Process content to render markdown properly
            const processedContent = renderMarkdownContent(result.content);
            
            contentDisplay.innerHTML = `
                <div class="text-content markdown-content">
                    <div class="content-header">
                        <h3>${result.topic}</h3>
                        <div class="content-meta">
                            <span class="meta-tag">${result.expertise} level</span>
                            <span class="meta-tag">${result.content_length || 'medium'} length</span>
                        </div>
                    </div>
                    <div class="content-body">
                        ${processedContent}
                    </div>
                </div>
            `;
        }
        
        function renderMarkdownContent(content) {
            // Simple markdown-to-HTML converter for better readability
            let html = content
                // Headers
                .replace(/^### (.*$)/gim, '<h3 class="content-h3">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="content-h2">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="content-h1">$1</h1>')
                // Code blocks
                .replace(/```r\n([\s\S]*?)```/g, '<div class="code-block r-code"><pre><code>$1</code></pre></div>')
                .replace(/```([\s\S]*?)```/g, '<div class="code-block"><pre><code>$1</code></pre></div>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong class="content-bold">$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em class="content-italic">$1</em>')
                // Lists
                .replace(/^\* (.*$)/gim, '<li class="list-item">$1</li>')
                .replace(/^- (.*$)/gim, '<li class="list-item">$1</li>')
                // Line breaks
                .replace(/\n\n/g, '</p><p class="content-paragraph">')
                .replace(/\n/g, '<br>');
            
            // Wrap in paragraph tags and handle lists
            html = '<p class="content-paragraph">' + html + '</p>';
            html = html.replace(/(<li class="list-item">.*<\/li>)/gs, function(match) {
                return '<ul class="content-list">' + match + '</ul>';
            });
            
            return html;
        }

        function displayAudioContent(result) {
            const contentDisplay = document.getElementById('contentDisplay');
            const audioPlayer = document.getElementById('audioPlayer');

            // Show text content first
            contentDisplay.innerHTML = `
                <div class="audio-content">
                    <div class="content-header">
                        <h3>üéµ ${result.topic}</h3>
                        <p class="audio-desc">Streaming audio content with Kyutai TTS</p>
                    </div>
                    <div class="content-body">
                        ${result.content}
                    </div>
                </div>
            `;

            // Set up streaming audio
            if (result.audio_stream_url) {
                audioPlayer.innerHTML = `
                    <div class="stream-player">
                        <h4><i class="fas fa-broadcast-tower"></i> Live Audio Stream</h4>
                        <audio controls autoplay id="streamAudio" style="width: 100%;">
                            <source src="${result.audio_stream_url}" type="audio/mpeg">
                            Your browser does not support audio streaming.
                        </audio>
                        <p class="stream-info">üî¥ Streaming live with Kyutai TTS</p>
                    </div>
                `;
                audioPlayer.style.display = 'block';
            }
        }

        function displayAnimatedContent(result) {
            const contentDisplay = document.getElementById('contentDisplay');
            const audioPlayer = document.getElementById('audioPlayer');
            
            contentDisplay.innerHTML = `
                <div class="animated-content">
                    <div class="content-header">
                        <h3>üé¨ ${result.topic}</h3>
                        <p class="animation-desc">Interactive animated presentation with audio narration</p>
                    </div>
                    <div class="animation-presentation">
                        <div class="slide-container" id="slideContainer">
                            ${result.animation_html || createAnimationSlides(result.topic, result.expertise)}
                        </div>
                        <div class="slide-progress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>
                    <div class="animation-controls">
                        <button class="control-btn" id="prevBtn" onclick="previousSlide()">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button class="control-btn" id="playPauseBtn" onclick="togglePlayPause()">
                            <i class="fas fa-play"></i> Play
                        </button>
                        <button class="control-btn" id="nextBtn" onclick="nextSlide()">
                            <i class="fas fa-chevron-right"></i> Next
                        </button>
                        <button class="control-btn" onclick="restartAnimation()">
                            <i class="fas fa-redo"></i> Restart
                        </button>
                    </div>
                </div>
            `;
            
            // Set up audio narration
            if (result.audio_stream_url) {
                audioPlayer.innerHTML = `
                    <div class="narration-player">
                        <h4><i class="fas fa-microphone"></i> Audio Narration</h4>
                        <audio controls id="narrationAudio" style="width: 100%;">
                            <source src="${result.audio_stream_url}" type="audio/mpeg">
                            Your browser does not support audio playback.
                        </audio>
                    </div>
                `;
                audioPlayer.style.display = 'block';
            }
            
            // Initialize animation state
            initializeAnimationPresentation();
        }

        // ============= ACTION HANDLERS =============
        function copyContent() {
            if (!currentContent) return;
            
            let textToCopy = '';
            switch (currentContent.output_type) {
                case 'text':
                case 'audio':
                    textToCopy = currentContent.content.replace(/<[^>]*>/g, '');
                    break;
                case 'animated':
                    textToCopy = `Animated Tutorial: ${currentContent.topic}`;
                    break;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert('Content copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy content.');
            });
        }

        function shareContent() {
            if (!currentContent) return;
            
            const shareData = {
                title: `R Tutorial: ${currentContent.topic}`,
                text: `Check out this R tutorial on ${currentContent.topic}`,
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                navigator.clipboard.writeText(shareData.url);
                alert('Tutorial link copied to clipboard!');
            }
        }

        function downloadContent() {
            if (!currentContent) return;
            
            const filename = `r-tutorial-${currentContent.topic.replace(/\s+/g, '-').toLowerCase()}.txt`;
            let content = '';
            
            switch (currentContent.output_type) {
                case 'text':
                case 'audio':
                    content = `R Tutorial: ${currentContent.topic}\n\n${currentContent.content.replace(/<[^>]*>/g, '')}`;
                    break;
                case 'animated':
                    content = `R Animated Tutorial: ${currentContent.topic}\n\nThis is an interactive animated tutorial.`;
                    break;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============= UTILITY FUNCTIONS =============
        function getOutputTypeLabel(type) {
            const labels = {
                'text': 'üìù Text Tutorial',
                'audio': 'üéµ Audio Content',
                'animated': 'üé¨ Animated Tutorial'
            };
            return labels[type] || type;
        }

        // Recent content loading removed for cleaner interface

        // ============= ANIMATION CONTROLS =============
        let currentSlide = 0;
        let totalSlides = 0;
        let isPlaying = false;
        let slideInterval = null;
        
        function initializeAnimationPresentation() {
            const slides = document.querySelectorAll('.animation-slide');
            totalSlides = slides.length;
            currentSlide = 0;
            
            if (totalSlides > 0) {
                showSlide(0);
                updateProgressBar();
            }
        }
        
        function createAnimationSlides(topic, expertise) {
            return `
                <div class="animation-slide active" data-slide="0">
                    <div class="slide-content">
                        <h2>üéØ Welcome to ${topic}</h2>
                        <div class="slide-visual">
                            <div class="animated-icon">
                                <i class="fab fa-r-project" style="font-size: 4rem; color: #276DC3;"></i>
                            </div>
                        </div>
                        <p class="slide-text">Let's explore ${topic} concepts step by step for ${expertise} level learners.</p>
                    </div>
                </div>
                <div class="animation-slide" data-slide="1">
                    <div class="slide-content">
                        <h2>üöÄ Getting Started</h2>
                        <div class="slide-visual">
                            <div class="code-animation">
                                <div class="code-line animate-typing">library(${topic.toLowerCase().replace(/\s+/g, '')})</div>
                                <div class="code-line animate-typing">data <- read.csv("sample.csv")</div>
                                <div class="code-line animate-typing">head(data)</div>
                            </div>
                        </div>
                        <p class="slide-text">Setting up your R environment and loading the necessary packages.</p>
                    </div>
                </div>
                <div class="animation-slide" data-slide="2">
                    <div class="slide-content">
                        <h2>üìä Key Concepts</h2>
                        <div class="slide-visual">
                            <div class="concept-flow">
                                <div class="concept-box">Input</div>
                                <div class="flow-arrow">‚Üí</div>
                                <div class="concept-box">Process</div>
                                <div class="flow-arrow">‚Üí</div>
                                <div class="concept-box">Output</div>
                            </div>
                        </div>
                        <p class="slide-text">Understanding the fundamental workflow and data processing concepts.</p>
                    </div>
                </div>
                <div class="animation-slide" data-slide="3">
                    <div class="slide-content">
                        <h2>üí° Practical Application</h2>
                        <div class="slide-visual">
                            <div class="result-display">
                                <div class="result-item animate-fadeIn">‚úì Data loaded successfully</div>
                                <div class="result-item animate-fadeIn">‚úì Analysis completed</div>
                                <div class="result-item animate-fadeIn">‚úì Results visualized</div>
                            </div>
                        </div>
                        <p class="slide-text">Applying ${topic} techniques to solve real-world problems.</p>
                    </div>
                </div>
                <div class="animation-slide" data-slide="4">
                    <div class="slide-content">
                        <h2>üéâ Summary</h2>
                        <div class="slide-visual">
                            <div class="success-animation">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: #38a169;"></i>
                            </div>
                        </div>
                        <p class="slide-text">Congratulations! You've mastered the basics of ${topic}. Keep practicing!</p>
                    </div>
                </div>
            `;
        }
        
        function showSlide(index) {
            const slides = document.querySelectorAll('.animation-slide');
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === index);
            });
            currentSlide = index;
            updateProgressBar();
        }
        
        function nextSlide() {
            if (currentSlide < totalSlides - 1) {
                showSlide(currentSlide + 1);
            } else {
                showSlide(0); // Loop back to start
            }
        }
        
        function previousSlide() {
            if (currentSlide > 0) {
                showSlide(currentSlide - 1);
            } else {
                showSlide(totalSlides - 1); // Loop to end
            }
        }
        
        function togglePlayPause() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            const narrationAudio = document.getElementById('narrationAudio');
            
            if (isPlaying) {
                // Pause
                clearInterval(slideInterval);
                if (narrationAudio) narrationAudio.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Play';
                isPlaying = false;
            } else {
                // Play
                slideInterval = setInterval(nextSlide, 3000); // Auto-advance every 3 seconds
                if (narrationAudio) narrationAudio.play();
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                isPlaying = true;
            }
        }
        
        function restartAnimation() {
            clearInterval(slideInterval);
            isPlaying = false;
            showSlide(0);
            const playPauseBtn = document.getElementById('playPauseBtn');
            const narrationAudio = document.getElementById('narrationAudio');
            
            if (playPauseBtn) playPauseBtn.innerHTML = '<i class="fas fa-play"></i> Play';
            if (narrationAudio) {
                narrationAudio.currentTime = 0;
                narrationAudio.pause();
            }
        }
        
        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            if (progressBar && totalSlides > 0) {
                const progress = ((currentSlide + 1) / totalSlides) * 100;
                progressBar.style.width = progress + '%';
            }
        }

    </script>
</body>
</html>
